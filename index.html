<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ØªØ¬Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDPcyxpHRuLx9T2CO4LJ-n9jaqAynUjvqw",
    authDomain: "xix5-a119a.firebaseapp.com",
    projectId: "xix5-a119a",
    storageBucket: "xix5-a119a.appspot.com",
    messagingSenderId: "332265425367",
    appId: "1:332265425367:web:0a95e71d8bd0058503a392",
    measurementId: "G-RLK4PXMV7P"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  function generateCode() {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    let code = "";
    for (let i = 0; i < 8; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  async function login(email, password) {
    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      document.getElementById("authPanel").style.display = "none";
      document.getElementById("userPanel").style.display = "block";
      document.getElementById("topBar").style.display = "flex";
      loadUserData(user.uid, user.email);
    } catch (error) {
      alert("Ø®Ø·Ø£: " + error.message);
    }
  }

  async function register(email, password) {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      const code = generateCode();
      await setDoc(doc(db, "users", user.uid), { 
        email: email,
        balance: 0,
        code: code,
        name: "Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯"
      });
      alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!");
    } catch (error) {
      alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + error.message);
    }
  }

  async function loadUserData(uid, email) {
    const userRef = doc(db, "users", uid);
    const userSnap = await getDoc(userRef);
    if(userSnap.exists()) {
      const data = userSnap.data();
      document.getElementById("displayCode").innerText = data.code || "------";
      document.getElementById("nameText").innerText = data.name || "Ù…Ø³ØªØ®Ø¯Ù…";
      document.getElementById("displayBalance").innerText = data.balance;

      // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      document.getElementById("editIcon").onclick = () => {
        document.getElementById("nameText").style.display = "none";
        document.getElementById("editIcon").style.display = "none";
        document.getElementById("nameInput").style.display = "inline-block";
        document.getElementById("saveBtn").style.display = "inline-block";
        document.getElementById("nameInput").value = document.getElementById("nameText").innerText;
      };
      document.getElementById("saveBtn").onclick = async () => {
        const newName = document.getElementById("nameInput").value;
        await updateDoc(doc(db, "users", uid), { name: newName });
        document.getElementById("nameText").innerText = newName;
        document.getElementById("nameText").style.display = "inline-block";
        document.getElementById("editIcon").style.display = "inline-block";
        document.getElementById("nameInput").style.display = "none";
        document.getElementById("saveBtn").style.display = "none";
      };

      if(email === "uusu.06@gmail.com") {
        document.getElementById("adminPanel").style.display = "block";
        await updateDoc(userRef, { balance: 10000000 });
        document.getElementById("adminBalance").innerText = "Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: 10000000$";
      }
    }
  }

  async function searchUser(identifier) {
    document.getElementById("modal").style.display = "flex";
    document.getElementById("modalContent").innerHTML = '<div class="loader"></div>';

    try {
      let data, uid;
      if(identifier.includes("@")) {
        const usersCol = collection(db, "users");
        const q = query(usersCol, where("email", "==", identifier));
        const querySnapshot = await getDocs(q);
        if(querySnapshot.empty){
          document.getElementById("modalContent").innerHTML = "<p>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!</p>";
          return null;
        }
        const userDoc = querySnapshot.docs[0];
        uid = userDoc.id;
        data = userDoc.data();
      } else {
        const usersCol = collection(db, "users");
        const q = query(usersCol, where("code", "==", identifier));
        const querySnapshot = await getDocs(q);
        if(querySnapshot.empty){
          document.getElementById("modalContent").innerHTML = "<p>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!</p>";
          return null;
        }
        const userDoc = querySnapshot.docs[0];
        uid = userDoc.id;
        data = userDoc.data();
      }

      document.getElementById("modalContent").innerHTML = `
        <p><b>Ø§Ù„Ø¨Ø±ÙŠØ¯:</b> ${data.email}</p>
        <p><b>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> ${data.balance} Ø¯ÙˆÙ„Ø§Ø±</p>
        <input type="number" id="chargeAmount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"><br>
        <button onclick="chargeUser('${uid}', ${data.balance})">Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯</button>
      `;
      return uid;
    } catch (err) {
      document.getElementById("modalContent").innerHTML = "<p>Ø®Ø·Ø£: "+err.message+"</p>";
    }
  }

  async function chargeUser(targetUid, currentBalance) {
    const amount = parseInt(document.getElementById("chargeAmount").value);
    if(!amount || amount <= 0) return alert("Ø§Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ§Ù„Ø­!");

    const adminUid = auth.currentUser.uid;
    const adminSnap = await getDoc(doc(db, "users", adminUid));
    const adminBalance = adminSnap.data().balance;

    if(auth.currentUser.email !== "uusu.06@gmail.com") return alert("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­!");
    if(adminBalance < amount) return alert("Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ ØºÙŠØ± ÙƒØ§ÙÙ!");

    await updateDoc(doc(db, "users", adminUid), { balance: adminBalance - amount });
    await updateDoc(doc(db, "users", targetUid), { balance: currentBalance + amount });

    alert("ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­!");
    document.getElementById("modal").style.display = "none";
    loadUserData(adminUid, auth.currentUser.email);
  }

  function logout() {
    signOut(auth).then(() => {
      document.getElementById("authPanel").style.display = "block";
      document.getElementById("userPanel").style.display = "none";
      document.getElementById("topBar").style.display = "none";
      document.getElementById("adminPanel").style.display = "none";
    });
  }

  window.login = login;
  window.register = register;
  window.searchUser = searchUser;
  window.chargeUser = chargeUser;
  window.logout = logout;
</script>

<style>
body { font-family: Cairo, sans-serif; text-align: center; padding: 20px; background:#f8f8f8;}
input { margin: 5px; padding: 7px; border:1px solid #ccc; border-radius:5px; }
button { padding: 7px 15px; margin-top: 5px; border:none; border-radius:5px; background:#3498db; color:#fff; cursor:pointer;}
button:hover{background:#2980b9;}
#adminPanel { display: none; margin-top: 20px; border: 1px solid #ccc; padding: 10px; background:#fff; border-radius:10px; }

#topBar {
  display:none;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(90deg,#2980b9,#6dd5fa);
  color: white;
  padding: 10px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}
#topBar span { margin: 0 10px; font-size: 16px; }
.balance-badge { background: gold; color: #222; padding: 8px 15px; border-radius: 30px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

#nameContainer { display:inline-block; }
#nameText { cursor: default; font-size:14px; color:#6c5ce7; font-weight:bold; }
#editIcon { cursor:pointer; margin-left:5px; color:#888; }
#nameInput { display:none; font-size:14px; padding:3px; border:1px solid #ccc; border-radius:5px; }
#saveBtn { display:none; background:#27ae60; color:white; border:none; border-radius:5px; padding:3px 7px; cursor:pointer; }

#modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
#modalContent { background: #fff; padding: 20px; border-radius: 10px; min-width: 250px; }
.loader { border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 40px; height: 40px; margin: auto; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<h1>Ù…ØªØ¬Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</h1>

<div id="topBar">
  <span><b>Ø§Ù„Ù…Ø¹Ø±Ù:</b> <span id="displayCode">------</span></span>
  <span id="nameContainer">
    <b>Ø§Ù„Ø§Ø³Ù…:</b>
    <span id="nameText">Ù…Ø³ØªØ®Ø¯Ù…</span>
    <span id="editIcon">âœï¸</span>
    <input type="text" id="nameInput">
    <button id="saveBtn">âœ”</button>
  </span>
  <span class="balance-badge"><span id="displayBalance">0</span>$</span>
</div>

<div id="authPanel">
  <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
  <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"><br>
  <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><br>
  <button onclick="login(loginEmail.value, loginPass.value)">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <hr>
  <h3>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h3>
  <input type="email" id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"><br>
  <input type="password" id="regPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"><br>
  <button onclick="register(regEmail.value, regPass.value)">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
</div>

<div id="userPanel" style="display:none; margin-top:20px;">
  <h3>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø± ğŸ‰</h3>
  <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
</div>

<div id="adminPanel">
  <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h3>
  <h4 id="adminBalance"></h4>
  <input type="text" id="targetInput" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯"><br>
  <button onclick="searchUser(targetInput.value)">Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
</div>

<div id="modal">
  <div id="modalContent"></div>
</div>

</body>
</html>
